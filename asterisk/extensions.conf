;INSTRUCTIONS FOR USER
;1. Modify these three variables in the "globals" section
;2. Modify the [default] section and create a configuration for each doorbell
[globals]
CONF_TIMEOUT=30 ;The number of seconds to wait before hanging up on an unanswered call
HA_URL=https://192.168.1.100 ;Your Home Assistant instance
HA_TOKEN=ABC123 ;Your Home Assistant access token

[general]
static=yes

;;;;;;;;;;;;;;;;;;;;;;;;;
; Reusable Macros
;;;;;;;;;;;;;;;;;;;;;;;;;
[doorbell-webhook]
;ARG1: event ARG2: confbridge ARG3: admin extension to call
exten => s,1,NoOp()
same => n,Set(RESULT=${SHELL(curl -s -X POST ${HA_URL}/api/services/asterisk_doorbell/${ARG1} -H 'Authorization: Bearer ${HA_TOKEN}' -H 'Content-Type: application/json' -d '{"confbridge":"${ARG2}","extension":"${ARG3}"}')})

[doorbell-user]
exten => s,1,Progress()
; Set the confbridge
 same  => n,Set(CONFBRIDGE=${ARG1})
; Set the admin extension
 same  => n,Set(ADMIN=${ARG2})
; Set the timeout extension
 same  => n,Set(TIMEOUT=${ARG3})
; Set the webhook extension
 same  => n,Set(WEBHOOK=${ARG4})
 same  => n,Originate(LOCAL/${WEBHOOK},exten,default,originated,1,10,v(ARG1=call^ARG2=${CONFBRIDGE}^ARG3=${ADMIN}))
; Asynchronous local channel call to disconnect doorbell after n secs if no answer
 same  => n,Originate(LOCAL/${TIMEOUT},exten,default,originated,1,$[${CONF_TIMEOUT} * 2],ac(s)v(ARG1=${CONFBRIDGE}))
 same  => n,NoOp(USER JOINING: Joining conference ${CONFBRIDGE} as default_user)
; Connect to confbridge
 same  => n,ConfBridge(${CONFBRIDGE},${CONFBRIDGE},default_user)
 same  => n,NoOp(USER LEAVING: User has left conference ${CONFBRIDGE})
 same  => n,Originate(LOCAL/${WEBHOOK},exten,default,originated,1,10,v(ARG1=terminate^ARG2=${CONFBRIDGE}^ARG3=${ADMIN}))

[doorbell-admin]
exten => s,1,Progress()
; Set the confbridge
 same  => n,Set(CONFBRIDGE=${ARG1})
; Set the admin extension
 same  => n,Set(ADMIN=${ARG2})
; Set the timeout extension
 same  => n,Set(TIMEOUT=${ARG3})
; Set the webhook extension
 same  => n,Set(WEBHOOK=${ARG4})
; Notify HA that the call is being answered
 same  => n,Originate(LOCAL/${WEBHOOK},exten,default,originated,1,5,v(ARG1=answered^ARG2=${CONFBRIDGE}^ARG3=${ADMIN}))
 same  => n,NoOp(ADMIN JOINING: Joining conference ${CONFBRIDGE} as admin_user)
 same  => n,ConfBridge(${CONFBRIDGE},${CONFBRIDGE},admin_user)
 same  => n,NoOp(ADMIN LEAVING: Admin has left conference ${CONFBRIDGE})

[doorbell-timeout]
exten => s,1,NoOp(TIMEOUT START: Conference=${ARG1})
; Wait CONF_TIMEOUT seconds before checking the number of participants
 same  => n,Wait(${CONF_TIMEOUT})
 same  => n,NoOp(CONF_INFO: Checking participants in ${ARG1})
 same  => n,Set(PARTY_COUNT=${CONFBRIDGE_INFO(parties,${ARG1})})
 same  => n,NoOp(CONF_INFO: Found ${PARTY_COUNT} participants in conference ${ARG1})
 same  => n,GotoIf($[${PARTY_COUNT} < 2]?exit)
 same  => n,Log(NOTICE,Call answered, found ${PARTY_COUNT} participants, exiting timeout routine)
 same  => n,Return()
 same  => n(exit),NoOp(TIMEOUT EXIT: No answer, kicking participants from ${ARG1})
 same  => n,ConfKick(${ARG1},all)
 same  => n,Log(NOTICE,No answer within time limit ending call)
 same  => n,Hangup()


[default]
;;;;;;;;;;;;;;;;;;;;;;;;;;;
; EXAMPLE CONFIGURATION WITH TWO DOORBELLS
; Organize your doorbells by grouping their extensions as shown below. The first doorbell should start at 9000,
; the second at 9100, etc.  You can copy and paste these examples, just remember to update the extension numbers and
; confbridge name
;;;;;;;;;;;;;;;;;;;;;;;;;;;

;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Doorbell #1: Front Door
;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Doorbell User
exten => 9000,1,NoOp()
; Call Dahua Doorbell Integration to notify that someone is at the door
 same => n,Gosub(doorbell-user,s,1(doorbell_front_door,9001,9002,9003))

; Admin User
exten => 9001,1,NoOp()
 same => n,Gosub(doorbell-admin,s,1(doorbell_front_door,9001,9002,9003))

; Timeout
exten => 9002,1,NoOp()
 same => n,Gosub(doorbell-timeout,s,1(doorbell_front_door))

; Webhook
exten => 9003,1,NoOp()
 same => n,Gosub(doorbell-webhook,s,1(${ARG1},${ARG2},${ARG3}))

;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Doorbell #2: Back Door
;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Doorbell User
exten => 9100,1,NoOp()
 same => n,Gosub(doorbell-user,s,1(doorbell_back_door,9101,9102,9103))

; Admin User
exten => 9101,1,NoOp()
 same => n,Gosub(doorbell-admin,s,1(doorbell_back_door,9101,9102,9103))

; Timeout
exten => 9102,1,NoOp()
 same => n,Gosub(doorbell-timeout,s,1(doorbell_back_door))

; Webhook
exten => 9103,1,NoOp()
 same => n,Gosub(doorbell-webhook,s,1(${ARG1},${ARG2},${ARG3}))
